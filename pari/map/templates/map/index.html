{% extends "base.html" %}
{% load i18n verbatim_tag %}

{% block meta_title %}{% trans "Map" %}{% endblock %}
{% block title %}{% trans "Map" %}{% endblock %}
{% block extra_js %}
    <script type='text/javascript' src="{{ STATIC_URL }}map/js/jquery-jvectormap-1.2.2.min.js"></script>
    <script type='text/javascript' src="{{ STATIC_URL }}map/js/jquery-jvectormap-in-mill-en.js"></script>
    <script type='text/javascript' src="{{ STATIC_URL }}js/handlebars.js"></script>
{% endblock %}
{% block extra_css %}
    <link href="{{ STATIC_URL }}map/css/jquery-jvectormap-1.2.2.css" rel="stylesheet" media="screen">
{% endblock %}

{% block extra_head %}
    {% verbatim %}
      <script id="article-template" type="text/x-handlebars-template">
        <div class="well well-large">
          <div class="page-header">
            <h1>{{name}} <small>{{description}}</small></h1>
          </div>
          <ul class="nav nav-list">
            {{#if articles}}
              <li class="nav-header">Articles</li>
              {{#each articles}}
                <li><a href="{{link}}">{{title}}</a></li>
              {{/each}}
            {{/if}}
            {{#if topics}}
              <li class="nav-header">Topics</li>
              {{#each topics}}
                <li><a href="{{link}}">{{title}}</a></li>
              {{/each}}
            {{/if}}
            <li class="divider"></li>
            <li><a href="{{link}}">View more content for {{name}}</a></li>
          </ul>
        </div>
      </script>
    {% endverbatim %}
{% endblock %}

{% block breadcrumb_menu %}
    <li class="active">{% trans "Map" %}</li>
{% endblock %}

{% block main %}
{% blocktrans %}
    <div class="container-fluid">
      <div class="row-fluid">
        <div id="map" class="span7" style="width: 800px; height: 720px"></div>
        <div id="side" class="span5"></div>
      </div>
    </div>

    <script type='text/javascript'>
        var source = $("#article-template").html();
        var template = Handlebars.compile(source);
        $.get('/articles/api/locations/?format=json', function(data) {
            $('#map').vectorMap({
              map: 'in_mill_en',
              regionStyle: {
                initial: {
                  fill: 'grey'
                }
              },
              backgroundColor: '#ffffff',
              markers: data,
              markerStyle: {
                initial: {
                    fill: '#F8E23B',
                    stroke: '#383f47'
                }
              },
              onMarkerClick: function(e, index){
                var latLng = data[index].latLng.join();
                $.get('/articles/api/locations/' + latLng + '/article/?format=json', function(locationData) {
                  var templateHtml= template(locationData);
                  $("#side").html(templateHtml);
                });

              }
            });
        });
    </script>
{% endblocktrans %}
{% endblock %}